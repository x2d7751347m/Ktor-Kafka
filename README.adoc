= Ktor web & websocket sample

== Tutorial movie

https://youtu.be/inZTW69HVk8

video::6pRl7A75_-4[youtube]

== Testing video

https://youtu.be/izDngUzWbrI

video::izDngUzWbrI[youtube]

== Swagger ui

http://127.0.0.1:8080

... If running on a local server

http://localhost:8080

== Kafka topic console

http://127.0.0.1:9080

... If running on a local server

http://localhost:9080

== How to tune

. Change parameters in `src/main/resources`
.. You don't have to create a matching Database. Just connect to your db and fill `src/main/resources/application.conf` > `ktor.deployment.db`
. Set aws environmental variables and github actions secrets in `.github/workflows/aws.yml`
. Run kafka server infrastructure using `docker compose up`

[source,bash]
.docker compose up command
----
docker compose up
----

== Architecture

=== Cloud Architecture of AWS ECS with ALB

image::.adoc/images/Cloud Architecture of AWS ECS with ALB.jpg[]

=== Producers and consumers writing and reading events from Kafka topics ( /messages/{group} )

image::.adoc/images/kafka-producers-consumers-topics.jpg[]

/chat consists of connections only within one server without kafka.

=== Ci/cd pipeline

image::.adoc/images/aws_architecture.jpg[]

== Database's table columns

image::.adoc/images/Db Table.PNG[]

== How to use

. Post a user
. Login via /login path to acquire `Authorization` key
. Set `Authorization` key to `Authorization` header
... Don't forget the prefix `Bearer `
... e.g) `Bearer eyJhbGciOiJIU....`
. Now you can access every apis and websocket!
.. websocket url e.g) ws://localhost:8080/chat

[source,bash]
.websocket commands
----
connections // Shows the number of connections (/chat path)
bye // command for disconnect
----

=== Notice

... You don't need to create a user when connecting to `/messages/{group}`.
... If you connected with `Authorization` header, the server shows your nickname.

.../admins/... paths can only be accessed by admins(set your role to `ADMIN`.)

